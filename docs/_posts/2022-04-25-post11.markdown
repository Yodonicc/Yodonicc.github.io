---
layout: post
title: "ä¸åŠ¨æºç ï¼Œè®©FFmpegå‘½ä»¤è¡Œæ‰§è¡Œæ—¶é—´ç¼©çŸ­400%"
date: 2022-04-25 06:02:20 -0000
categories: frontend FFmpeg
---
> ä½œè€…ï¼š[Jerome Wu](https://jeromewus.medium.com/?source=post_page-----ed12bf4c8fac-----------------------------------)
>
> åŸæ–‡é“¾æ¥ï¼š[Speedup FFmpeg without compiling from source code](https://itnext.io/speedup-ffmpeg-without-compiling-from-source-code-c1f34d4ec544)
>
> è¯‘è€…ï¼š[Yodonicc](https://github.com/Yodonicc)

FFmpegæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤šåª’ä½“å¤„ç†å·¥å…·ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä½¿ç”¨å¤šçº¿ç¨‹çš„CPUæ¥å®Œæˆä»»åŠ¡ï¼Œè¿™ç»™ä½ çš„ç”µè„‘å¸¦æ¥äº†å¾ˆé«˜çš„è´Ÿè·ï¼Œåœ¨å¤§å¤šæ•°æ—¶å€™æ˜¯å¾ˆæ…¢çš„ã€‚

å¦‚æœä½ åœ¨è°·æ­Œä¸Šæœç´¢å¦‚ä½•æé«˜FFmpegçš„é€Ÿåº¦ï¼Œä½ å¯èƒ½ä¼šå‘ç°å…³äºä½¿ç”¨`-preset`çš„è®¨è®ºï¼Œå®ƒé™ä½äº†å‹ç¼©ç‡ä»¥è·å¾—æ›´é«˜çš„é€Ÿåº¦ï¼ˆæ–‡ä»¶å¤§å°å’Œé€Ÿåº¦ä¹‹é—´çš„æƒè¡¡ï¼‰ï¼Œå¦ä¸€ä¸ªæ€§æ„Ÿçš„æ–¹æ³•æ˜¯åˆ©ç”¨nVidia GPUï¼ˆnvencï¼Œnvdecå’Œcuvidï¼‰ï¼Œä½†è¿™å¹¶ä¸å®¹æ˜“ï¼š

- ä½ æ²¡æœ‰ä¸€ä¸ªå…¼å®¹çš„nVidia GPUå¡
- ä½ éœ€è¦å®‰è£…nVidia GPUé©±åŠ¨å’ŒCUDAï¼ˆåœ¨Linuxç¯å¢ƒä¸‹å¾ˆç—›è‹¦ï¼‰
- å¦‚æœä½ æ‰¾ä¸åˆ°å¯ä»¥ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œä½ éœ€è¦ä»æºå¤´ä¸Šç¼–è¯‘FFmpegã€‚

æ ¹æ®æˆ‘è‡ªå·±çš„ç»éªŒï¼Œæˆ‘èŠ±äº†å¾ˆå¤šå°æ—¶ç ”ç©¶å¦‚ä½•å®‰è£…å’Œç¼–è¯‘FFmpegï¼Œä½†æœ€åè¿˜æ˜¯å¤±è´¥äº†ï¼Œå› ä¸ºæˆ‘çš„GPUæ— æ³•æ”¯æŒå¤§éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œè¿™è®©æˆ‘å¾ˆéš¾è¿‡ã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥è®©FFmpegæ›´å¿«ï¼Ÿæœ‰çš„ï¼Œè€Œä¸”ä½ å¯ä»¥åœ¨å‡ ç§’é’Ÿå†…ç”¨`VAAPI`åšåˆ°è¿™ä¸€ç‚¹ã€‚è®©æˆ‘ä»¬åšä¸ªå®éªŒï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆä¸åŒã€‚

### åŸºå‡†çº¿ï¼šç¼©æ”¾ä¸€ä¸ªè§†é¢‘ï¼Œä¸åŠ ä»»ä½•é¢å¤–é€‰é¡¹

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œæä¾›ä¸åŒè´¨é‡çš„è§†é¢‘æµï¼ˆ720pã€1080pç­‰ï¼‰ï¼Œæ‰€ä»¥ä½ éœ€è¦å°†ä¸Šä¼ çš„è§†é¢‘ç¼©å‡åˆ°ä¸åŒçš„åˆ†è¾¨ç‡ã€‚

è®©æˆ‘ä»¬ä»[h264info](https://www.h264info.com/clips.html)ä¸‹è½½ä¸€ä¸ªæ ·æœ¬è§†é¢‘ï¼Œå¹¶åœ¨æ²¡æœ‰ä»»ä½•é€‰é¡¹çš„æƒ…å†µä¸‹è¿›è¡Œç¼©æ”¾ï¼š

``````shell
$ ffmpeg -i gravity.mp4 \
    -c:v libx264 \
    -s 1024x428 \
    -b:v 1M \
    out.mp4
``````

å®ƒéœ€è¦å¤§çº¦42ç§’ï¼ˆé€Ÿåº¦=3.5å€ï¼‰ï¼Œæ–‡ä»¶å¤§å°ä¸º21MBã€‚(åŸå§‹å¤§å°ä¸º355 MB)

### ç”¨-presetæ¥åŠ é€Ÿæ›´å¤§çš„æ–‡ä»¶å¤§å°

> ç‚¹å‡»[è¿™é‡Œ](https://trac.ffmpeg.org/wiki/Encode/H.264)äº†è§£æ›´å¤šå…³äºpresetçš„ç»†èŠ‚

ä½¿ç”¨presetï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°ä»¥æ›´å¤§çš„æ–‡ä»¶å¤§å°æ¥åŠ é€ŸFFmpegï¼Œå½“ä½ çš„ç¡¬ç›˜æœ‰è¶³å¤Ÿçš„ç©ºé—´æ—¶ï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„ã€‚

``````shell
$ ffmpeg -i gravity.mp4 \
    -c:v libx264 \
    -preset ultrafast \
    -s 1024x428 \
    -b:v 1M \
    out.mp4
``````

è¿™éœ€è¦å¤§çº¦22ç§’ï¼ˆé€Ÿåº¦=6å€ï¼‰ï¼Œæ–‡ä»¶å¤§å°ä¸º20MBã€‚(æœ‰è¶£çš„æ˜¯ï¼Œå®ƒæ¯”`-preset default`ğŸ˜è¦å°ï¼‰ã€‚

### ä½¿ç”¨VAAPIæ¥åŠ å¿«é›†æˆ/è‹±ç‰¹å°”GPUå¡çš„é€Ÿåº¦

è§†é¢‘åŠ é€ŸAPIï¼ˆVAAPIï¼‰åœ¨FFmpegä¸­å¹¶ä¸æ˜¯ä¸€ä¸ªç§˜å¯†ï¼Œä½†å¾ˆéš¾æ³¨æ„åˆ°å®ƒæ˜¯å¦‚ä½•è½»æ¾å¸®åŠ©ä½ åŠ é€ŸFFmpegçš„ã€‚ä½¿ç”¨VAAPIçš„å¥½å¤„æ˜¯ï¼š

- é›†æˆGPUå¡å¾ˆä¾¿å®œï¼ˆè€Œä¸”ä½ ç°åœ¨å·²ç»æœ‰ä¸€ä¸ªäº†ï¼‰
- ä½ åªéœ€è¦å®‰è£…`i965-va-driver`å°±å¯ä»¥äº†ã€‚
- ä½ ä¸éœ€è¦ç¼–è¯‘FFmpegï¼Œå› ä¸ºè¿™ä¸ªæ ‡å¿—æ˜¯é»˜è®¤å¯ç”¨çš„ã€‚

è¦åœ¨Ubuntuä¸­ä½¿ç”¨VAAPIï¼Œé¦–å…ˆä½ éœ€è¦å®‰è£…é©±åŠ¨ç¨‹åºå¹¶ä½¿ç”¨`vainfo`å‘½ä»¤æ£€æŸ¥çŠ¶æ€ã€‚

``````shell
$ sudo apt-get install i965-va-driver
$ vainfo
libva info: VA-API version 1.1.0
libva info: va_getDriverName() returns 0
libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/i965_drv_video.so
libva info: Found init function __vaDriverInit_1_1
libva info: va_openDriver() returns 0
vainfo: VA-API version: 1.1 (libva 2.1.0)
vainfo: Driver version: Intel i965 driver for Intel(R) Ivybridge Mobile - 2.1.0
vainfo: Supported profile and entrypoints
      VAProfileMPEG2Simple            : VAEntrypointVLD
      VAProfileMPEG2Simple            : VAEntrypointEncSlice
      VAProfileMPEG2Main              : VAEntrypointVLD
      VAProfileMPEG2Main              : VAEntrypointEncSlice
      VAProfileH264ConstrainedBaseline: VAEntrypointVLD
      VAProfileH264ConstrainedBaseline: VAEntrypointEncSlice
      VAProfileH264Main               : VAEntrypointVLD
      VAProfileH264Main               : VAEntrypointEncSlice
      VAProfileH264High               : VAEntrypointVLD
      VAProfileH264High               : VAEntrypointEncSlice
      VAProfileH264StereoHigh         : VAEntrypointVLD
      VAProfileVC1Simple              : VAEntrypointVLD
      VAProfileVC1Main                : VAEntrypointVLD
      VAProfileVC1Advanced            : VAEntrypointVLD
      VAProfileNone                   : VAEntrypointVideoProc
      VAProfileJPEGBaseline           : VAEntrypointVLD
``````

å¦‚æœä½ çœ‹åˆ°ç±»ä¼¼ä¸Šè¿°çš„è¾“å‡ºï¼Œè¯´æ˜ä½ çš„è‹±ç‰¹å°”GPUå¡æ”¯æŒVAAPIï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æ‰§è¡Œscaleï¼š

``````shell
$ ffmpeg -hwaccel vaapi \
    -hwaccel_device /dev/dri/renderD129 \
    -hwaccel_output_format vaapi \
    -i gravity.mp4 \
    -vf "scale_vaapi=w=1024:h=428" \
    -c:v h264_vaapi \
    -b:v 1M \
    out.mp4
``````

è¿™éœ€è¦å¤§çº¦10ç§’ï¼ˆé€Ÿåº¦=14.3å€ï¼‰ï¼Œæ–‡ä»¶å¤§å°ä¸º19MBã€‚

æŠŠå®ƒä»¬æ”¾åœ¨ä¸€ä¸ªå›¾è¡¨ä¸­ï¼Œä½¿ç”¨VAAPIå¯ä»¥å¾—åˆ°æ¯”æœ¬åœ°å¿«4å€çš„é€Ÿåº¦ï¼Œè€Œä¸”æ–‡ä»¶å¤§å°ä¹Ÿå°ä¸€ç‚¹ã€‚

<image id="img" src="/public/post11image1.png" style="max-width: 730px;" >
</image>

äº‹å®ä¸Šï¼Œå¦‚æœä½ æŠ•å…¥æ—¶é—´å’Œç²¾åŠ›æ¥è°ƒæŸ¥nVidia GPUé€‰é¡¹ï¼Œä½ å¯ä»¥æœ‰æ›´å¿«çš„é€Ÿåº¦ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¼Ÿå¤§çš„é€Ÿåº¦ï¼Œæ²¡æœ‰å¤ªå¤šçš„åŠªåŠ›å’Œæˆæœ¬ï¼Œä¸æ˜¯å—ï¼ŸğŸ˜„

å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œä¸è¦çŠ¹è±«ï¼Œç•™ä¸‹ä»»ä½•è¯„è®ºæˆ–ç‚¹èµï¼Œè°¢è°¢ä½ ï¼

æ³¨ï¼š**ç‰¹åˆ«æ„Ÿè°¢æŠ€æœ¯æŒ‡å¯¼dazhao(èµµè¾¾)å¯¹æœ¬æ–‡ç¿»è¯‘çš„å®¡é˜…æŒ‡æ­£**ã€‚