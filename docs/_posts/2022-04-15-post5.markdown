---
layout: post
title: "ç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆffmpeg.wasmï¼‰ï¼šï¼ˆ5ï¼‰ffmpeg.wasm v0.3 - pre.jsä¸å®æ—¶éŸ³è§†é¢‘æµ"
date: 2022-04-15 09:02:20 -0000
categories: å‰ç«¯ éŸ³è§†é¢‘
---

> ä½œè€…ï¼š[Jerome Wu](https://jeromewus.medium.com/?source=post_page-----ed12bf4c8fac-----------------------------------)
>
> åŸæ–‡é“¾æ¥ï¼š[Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.5 ffmpeg.wasm v0.3 â€” pre-js and live streaming (OUTDATED)](https://itnext.io/build-ffmpeg-webassembly-version-ffmpeg-js-part-5-ffmpeg-js-v0-3-pre-js-and-live-streaming-c1498939a74c)
>
> è¯‘è€…ï¼š[Yodonicc](https://yodonicc.github.io/)

ä¸Šä¸€ç¯‡æ–‡ç« ï¼š[ç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆffmpeg.wasmï¼‰ï¼šï¼ˆ4ï¼‰ffmpeg.wasm v0.2 - æ·»åŠ Libx264](https://yodonicc.github.io/%E5%89%8D%E7%AB%AF/%E9%9F%B3%E8%A7%86%E9%A2%91/2022/04/14/post4.html)

åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œä½ å°†å­¦ä¹ ï¼š

1. ä½¿ç”¨--pre-jsæ¥é‡æ–°å®šä¹‰æ¨¡å—ä¸­çš„å‡½æ•°
2. åŒæ—¶ä½¿ç”¨ffmpeg.jså’Œç½‘ç»œæ‘„åƒå¤´

### ä½¿ç”¨`--pre-js`æ¥é‡æ–°å®šä¹‰æ¨¡å—ä¸­çš„å‡½æ•°

FFmpegæœ‰å¤§é‡çš„è¾“å‡ºï¼Œå®ƒåŒ…å«é‡è¦çš„ä¿¡æ¯ï¼Œå¦‚è§†é¢‘çš„å…ƒæ•°æ®ï¼Œç¼–ç å™¨/è§£ç å™¨çš„è¾“å‡ºå’Œä»»åŠ¡çš„è¿›å±•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›ä¿¡æ¯æ˜¯ç”±æœ¬åœ°Cè¯­è¨€åº“`printf`/`sprintf`æ‰“å°çš„ï¼Œè™½ç„¶ä½ å¯ä»¥åœ¨DevToolsä¸­çœ‹åˆ°ï¼Œä½†ä½ ä¸èƒ½ç”¨JavaScriptæ¥æ“ä½œã€‚

å¹¸è¿çš„æ˜¯ï¼Œåœ¨Emscriptenä¸­æˆ‘ä»¬å¯ä»¥ç”¨`--pre-js`æˆ–`--post-js`é‡æ–°å®šä¹‰ä¸€äº›[é»˜è®¤å‡½æ•°](https://emscripten.org/docs/api_reference/module.html)çš„è¡Œä¸ºã€‚å¯¹äºä¸Šé¢çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å®šä¹‰çš„å‡½æ•°æ˜¯`Module['printErr']`ï¼ˆå› ä¸ºFFmpegçš„è¾“å‡ºä½¿ç”¨`stderr`ï¼‰ï¼Œå¹¶ä¸”ç”¨`-pre-js`æ·»åŠ åˆ°æˆ‘ä»¬çš„ffmpeg.jsä¸­ã€‚
ä¸‹é¢æ˜¯æˆ‘å­¦åˆ°çš„ä¸€äº›ç»éªŒä¾›ä½ å‚è€ƒã€‚

+ ä½ åªèƒ½åœ¨`--pre-js`ä¸­ä½¿ç”¨ES5è¯­æ³•ï¼ˆæ²¡æœ‰ç®­å¤´å‡½æ•°ã€constã€letï¼‰
+ ä½ éœ€è¦æ·»åŠ é¢å¤–çš„å®æ¥é˜²æ­¢ä½ çš„ä»£ç è¢«Closureç¼–è¯‘å™¨åˆ é™¤ï¼ˆè¿™é‡Œæˆ‘æ²¡æœ‰ä½¿ç”¨Closureç¼–è¯‘å™¨ï¼‰

è¿™é‡Œæ˜¯ç›®å‰ffmpeg.jsä¸­ä½¿ç”¨çš„`prepend.js`:

``````javascript
var logger = function(){}

Module['setLogger'] = function(_logger) { logger = _logger; };
Module['print'] = function(message) { logger(message, 'stdout'); };
Module['printErr'] = function(message) { logger(message, 'stderr'); };

``````

æˆ‘ä»¬å®é™…ä¸Šå®šä¹‰äº†ä¸€ä¸ªæ–°çš„å‡½æ•°`setLogger`æ¥æ³¨å†Œæˆ‘ä»¬çš„è‡ªå®šä¹‰è®°å½•å™¨å‡½æ•°ï¼Œå¹¶é‡æ–°å®šä¹‰äº†ä¸¤ä¸ªç°æœ‰çš„å‡½æ•°`print`å’Œ`printErr`ã€‚æœ‰äº†è¿™ä¸ªprepend.jsï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ“ä½œFFmpegçš„è¾“å‡ºä¿¡æ¯ï¼Œå¼€å‘æ›´å¤šçš„åŠŸèƒ½ï¼ˆå¦‚è¿›åº¦æ¡ï¼‰ã€‚

åœ¨æ„å»ºè„šæœ¬ä¸­æ·»åŠ `--pre-js`å¾ˆå®¹æ˜“ï¼ˆç¬¬54è¡Œï¼‰

``````shell
#!/bin/bash -x

set -e -o pipefail

BUILD_DIR=$PWD/build

build_x264() {
  cd third_party/x264
  emconfigure ./configure \
    --disable-asm \
    --disable-thread \
    --prefix=$BUILD_DIR
  emmake make install-lib-static
  cd -
}

configure_ffmpeg() {
  emconfigure ./configure \
    --enable-gpl \
    --enable-libx264 \
    --disable-pthreads \
    --disable-x86asm \
    --disable-inline-asm \
    --disable-doc \
    --disable-stripping \
    --disable-ffprobe \
    --disable-ffplay \
    --disable-ffmpeg \
    --prefix=$BUILD_DIR \
    --extra-cflags="-I$BUILD_DIR/include" \
    --extra-cxxflags="-I$BUILD_DIR/include" \
    --extra-ldflags="-L$BUILD_DIR/lib" \
    --nm="llvm-nm -g" \
    --ar=emar \
    --cc=emcc \
    --cxx=em++ \
    --objcc=emcc \
    --dep-cc=emcc
}

make_ffmpeg() {
  NPROC=$(grep -c ^processor /proc/cpuinfo)
  emmake make -j${NPROC}
}

build_ffmpegjs() {
  emcc \
    -I. -I./fftools -I$BUILD_DIR/include \
    -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample -Llibpostproc -L${BUILD_DIR}/lib \
    -Qunused-arguments -Oz \
    -o dist/ffmpeg-core.js fftools/ffmpeg_opt.c fftools/ffmpeg_filter.c fftools/ffmpeg_hw.c fftools/cmdutils.c fftools/ffmpeg.c \
    -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lpostproc -lm -lx264 \
    --closure 1 \
    --pre-js javascript/prepend.js \    # add HERE
    -s USE_SDL=2 \
    -s MODULARIZE=1 \
    -s SINGLE_FILE=1 \
    -s EXPORTED_FUNCTIONS="[_ffmpeg]" \
    -s EXTRA_EXPORTED_RUNTIME_METHODS="[cwrap, FS, getValue, setValue]" \
    -s TOTAL_MEMORY=33554432 \
    -s ALLOW_MEMORY_GROWTH=1
}

main() {
  build_x264
  configure_ffmpeg
  make_ffmpeg
  build_ffmpegjs
}

main "$@"
view rawbuild_ffmpeg-core.js-v0.3.sh hosted with â¤ by GitHub
``````

ç°åœ¨æˆ‘ä»¬åœ¨æ¨¡å—å¯¹è±¡ä¸­æœ‰äº†`setLogger`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆå§‹åŒ–åä½¿ç”¨å®ƒï¼ˆç¬¬13è¡Œï¼‰

``````javascript
/**
 * This script is loaded by ffmpegwasm-v0.2.js
 */

let Module = null;
let ffmpeg = null;

const load = () => {
  global.importScripts('./ffmpeg-core.js');
  global.Module()
    .then((_Module) => {
      Module = _Module;
      Module.setLogger(m => console.log(m));
      ffmpeg = Module.cwrap('ffmpeg', 'number', ['number', 'number']);
      postMessage({ action: 'load', payload: { loaded: true } });
    });
};
 
const transcode = ({ data: _data, outputExt }) => {
  /* When an array received from postMessage,
   * its format will change to an "ArrayLike" object,
   * we need to transform it back to array
   */
  const data = Uint8Array.from({ ..._data, length: Object.keys(_data).length });
  const args = ['./ffmpeg', '-i', 'file:media', `media.${outputExt}`];
  Module.FS.writeFile('media', data);
  ffmpeg(args.length, strList2ptr(args));
  postMessage({
    action: 'transcode',
    payload: {
      data: Module.FS.readFile(`media.${outputExt}`),
    },
  });
};

global.addEventListener('message', ({ action, payload }) => {
  if (action === 'load') {
    load(payload);
  } else if (action === 'transcode') {
    transcode(payload);
  }
});
view rawworker-v0.3.js hosted with â¤ by GitHub
``````

### ä½¿ç”¨`ffmpeg.js`ä¸ç½‘ç»œæ‘„åƒå¤´

åœ¨è¿™é‡Œï¼Œæˆ‘æƒ³æè¿°ä¸€ä¸‹å¦‚ä½•å°†ffmpegç”¨äºæµåª’ä½“ç›´æ’­ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ç½‘ç»œæ‘„åƒå¤´ä½œä¸ºä¾‹å­ï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹åº”è¯¥æœ‰ç±»ä¼¼çš„å·¥ä½œæµç¨‹ã€‚

åŸºæœ¬çš„å·¥ä½œæµç¨‹æ˜¯ï¼š

1. ä½¿ç”¨MediaRecorder APIå°†æµåª’ä½“ä¿å­˜åˆ°Blobä¸­
2. å°†Blobè½¬æ¢ä¸ºUint8Arrayæ•°æ®
3. ä½¿ç”¨ffmpeg.jså¯¹Uint8Arrayæ•°æ®è¿›è¡Œè½¬ç 

æ­¥éª¤1 ä½¿ç”¨`getUserMedia`è®¿é—®ç½‘ç»œæ‘„åƒå¤´ï¼ˆéœ€è¦httpsåè®®ï¼‰

``````html
<video id="webcam" width="320px" height="180px"></video>
<script>
const webcam = document.getElementById('webcam');
(async () => {
  webcam.srcObject = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  await webcam.play();
})();
</script>
``````

ç¬¬2æ­¥ï¼šä½¿ç”¨`MediaRecorder`æ¥å½•åˆ¶ç‰‡æ®µ

``````javascript
const startRecording = () => {
  const rec = new MediaRecorder(webcam.srcObject);
  const chunks = [];
  rec.ondataavailable = e => chunks.push(e.data);
  rec.onstop = async () => {
    transcode(new Uint8Array(await (new Blob(chunks)).arrayBuffer()));
  };
  rec.start();
};

``````

æ­¥éª¤3 é‡å¤ä½¿ç”¨ä¸Šä¸€éƒ¨åˆ†çš„trancodeæ¥åšè½¬ç ã€‚

åœ¨ç¬¬äº”ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨`--pre-js`æ¥é‡æ–°å®šä¹‰/æ‰©å±•æ¨¡å—çš„èƒ½åŠ›ï¼Œå¹¶ä»‹ç»äº†ä¸€ä¸ªå¦‚ä½•åœ¨æµåª’ä½“ç›´æ’­åœºæ™¯ä¸­ä½¿ç”¨ffmpegçš„ä¾‹å­ã€‚

åœ¨ç¬¬å…­ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ·±å…¥ç ”ç©¶ï¼šç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆffmpeg.wasmï¼‰ï¼š(6) æ·±å…¥ç ”ç©¶æ–‡ä»¶ç³»ç»ŸğŸ˜ƒ

ä»£ç ç›®å½•ï¼š

+ ffmpeg-core.js: https://github.com/ffmpegjs/FFmpeg
+ ffmpeg.js: https://github.com/ffmpegjs/ffmpeg.js

æ³¨ï¼š**ç‰¹åˆ«æ„Ÿè°¢æŠ€æœ¯æŒ‡å¯¼dazhao(èµµè¾¾)å¯¹æœ¬æ–‡ç¿»è¯‘çš„å®¡é˜…æŒ‡æ­£**ã€‚