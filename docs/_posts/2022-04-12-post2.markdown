---
layout: post
title: "ç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆffmpeg.wasmï¼‰ï¼šï¼ˆ2ï¼‰ä½¿ç”¨Emscriptenç¼–è¯‘"
date: 2022-04-12 09:02:20 -0000
categories: å‰ç«¯ éŸ³è§†é¢‘
---

# **ç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆffmpeg.wasmï¼‰ï¼šï¼ˆ2ï¼‰ä½¿ç”¨Emscriptenç¼–è¯‘**

> ä½œè€…ï¼š[Jerome Wu](https://jeromewus.medium.com/?source=post_page-----ed12bf4c8fac-----------------------------------)
>
> åŸæ–‡é“¾æ¥ï¼š[Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.2 Compile with Emscripten](https://itnext.io/build-ffmpeg-webassembly-version-ffmpeg-js-part-2-compile-with-emscripten-4c581e8c9a16)
>
> è¯‘è€…ï¼š[Yodoxu](https://github.com/Yodonicc)
>
> 2020/9æ›´æ–°ï¼šä¿®æ”¹æ•™ç¨‹ï¼Œä½¿å…¶èƒ½åœ¨MacOSä¸­è¿è¡Œã€‚
>
> 2020/2/11æ›´æ–°ï¼šä»è¿™ä¸ªæ–‡ç« çš„å›å¤æ¥çœ‹ï¼Œç›®å‰ä¸‹é¢çš„è¯´æ˜åœ¨Macç¯å¢ƒä¸‹æ— æ³•å·¥ä½œã€‚æˆ‘æ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæˆ‘å¹¶ä¸æ‹¥æœ‰ä¸€å°ã€‚åœ¨Macä¸­æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨è™šæ‹Ÿæœºä¸­å®‰è£…Linuxå‘è¡Œç‰ˆï¼Œå¦‚Ubuntuã€‚

ä¸Šä¸€ç¯‡æ–‡ç« ï¼š[ç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆffmpeg.wasmï¼‰ï¼šï¼ˆ1ï¼‰å‡†å¤‡](https://yodonicc.github.io/%E5%89%8D%E7%AB%AF/%E9%9F%B3%E8%A7%86%E9%A2%91/2022/04/11/post1.html)

> ä»è¿™é‡Œå¼€å§‹ï¼Œäº‹æƒ…ä¼šå˜å¾—æ›´åŠ å¤æ‚å’Œéš¾ä»¥ç†è§£ï¼Œå¦‚æœä½ ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä½ å¯èƒ½éœ€è¦è°·æ­ŒèƒŒæ™¯çŸ¥è¯†ï¼ˆæˆ–è€…ä½ å¯ä»¥ç•™ä¸‹å›å¤æ¥é—®æˆ‘ï¼‰ã€‚
>
> å¦å¤–ï¼Œä¸ºäº†ä½¿è¿™ä¸ªæ•™ç¨‹æ›´å®ç”¨ï¼Œæˆ‘å°½é‡å†™ä¸‹æˆ‘æ˜¯å¦‚ä½•è§£å†³æ¯ä¸ªé—®é¢˜çš„ç»†èŠ‚ï¼Œå¸Œæœ›å®ƒèƒ½å¸®åŠ©ä½ å»ºç«‹ä½ é€‰æ‹©çš„åº“ã€‚

åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œä½ å°†å­¦ä¹ ï¼š

1. å¦‚ä½•ä½¿ç”¨Dockerè®¾ç½®Emscriptençš„ç¯å¢ƒ

2. `emconfigure`å’Œ`emmake`çš„ç”¨æ³•

3. å¦‚ä½•è§£å†³ç”¨Emscriptenç¼–è¯‘FFmpegæ—¶çš„é—®é¢˜

   

### å¦‚ä½•ä½¿ç”¨Dockerè®¾ç½®Emscriptençš„ç¯å¢ƒ

åœ¨[ç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆffmpeg.wasmï¼‰ï¼šï¼ˆ1ï¼‰å‡†å¤‡](https://yodonicc.github.io/%E5%89%8D%E7%AB%AF/%E9%9F%B3%E8%A7%86%E9%A2%91/2022/04/11/post1.html)ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç”¨GCCæ„å»ºäº†åŸå§‹ç‰ˆæœ¬çš„FFmpegï¼Œç°åœ¨æˆ‘ä»¬è½¬è€Œä½¿ç”¨Emscriptenã€‚

æˆ‘ä»¬è¦ä½¿ç”¨çš„Emscriptenç‰ˆæœ¬æ˜¯1.39.18ï¼ˆtrzeci/emscripten:1.39.18-upstreamï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡[å®˜æ–¹æ•™ç¨‹](https://emscripten.org/docs/getting_started/downloads.html#installation-instructions)å®‰è£…Emscriptenï¼ˆåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨MacOSä¸­ä½¿ç”¨[setup-emsdk](https://github.com/mymindstorm/setup-emsdk) Github Actionsï¼‰æˆ–è€…ä»docker hubæ‹‰å–Emscriptené•œåƒã€‚

```shell
$ docker pull trzeci/emscripten:1.39.18-upstream
```

> è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿçš„æ—¶é—´ï¼Œå› ä¸ºå…¶å¤§å°çº¦ä¸º1GBã€‚

ç„¶åæˆ‘ä»¬éœ€è¦æ›´æ–°`build-with-docker.sh`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
#!/bin/bash -x

EM_VERSION=1.39.18-upstream

docker pull trzeci/emscripten:$EM_VERSION
docker run \
  -v $PWD:/src \
  -v $PWD/cache-wasm:/emsdk_portable/.data/cache/wasm \
  trzeci/emscripten:$EM_VERSION \
  sh -c 'bash ./build.sh'
```

> ç¬¬8è¡Œ'-v $PWD/cache-wasm:/emsdk_portable/.data/cache/wasm'ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†å®ƒå¯ä»¥å¸®åŠ©ä½ åœ¨åç»­çš„æ„å»ºä¸­åŠ å¿«é€Ÿåº¦ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„æ˜¯æ‰¾åˆ°ç”¨emscriptenç¼–è¯‘FFmpegçš„é…ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªå°è¯•å’Œé”™è¯¯çš„è¿‡ç¨‹ï¼Œéœ€è¦æœç´¢æ–‡æ¡£å’Œä¿æŒè€å¿ƒã€‚

### `emconfigure`å’Œ`emmake &`çš„ç”¨æ³•ä»¥åŠå¦‚ä½•è§£å†³ç”¨Emscriptenç¼–è¯‘FFmpegçš„é—®é¢˜

è®©æˆ‘ä»¬å¼€å§‹å¯»æ‰¾æ­£ç¡®é…ç½®çš„æ—…ç¨‹ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œå®ƒä»¥`./configure --disable-x86asm`å¼€å§‹ï¼Œè¦ç”¨emscriptenåšï¼Œä½ éœ€è¦æŠŠå®ƒæ”¹ä¸º`emconfigure ./configure --disable-x86asm`ã€‚(å…³äºemconfigureçš„ç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹[è¿™é‡Œ](https://emscripten.org/docs/compiling/Building-Projects.html#integrating-with-a-build-system))ï¼Œç”±äºæˆ‘ä»¬è¦è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ äº¤å‰ç¼–è¯‘çš„æ ‡å¿—æ¥æ˜ç¡®å‘Šè¯‰FFmpegã€‚

è®©æˆ‘ä»¬æ›´æ–°`build.sh`ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
ARGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
)
emconfigure ./configure "${ARGS[@]}"
```

ç¥å¥‡çš„æ˜¯ï¼Œæ²¡æœ‰ä»»ä½•é”™è¯¯æˆ–ä»»ä½•ä¸å¦¥ä¹‹å¤„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦åªéœ€è¦è¾“å…¥`emmake make -j`å°±å¯ä»¥å¾—åˆ°FFmpeg.wasmï¼Ÿä¸å¹¸çš„æ˜¯ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚`emconfigure`æœ€é‡è¦çš„ä»»åŠ¡ä¹‹ä¸€æ˜¯å°†ç¼–è¯‘å™¨ä»gccæ›¿æ¢æˆemccï¼ˆæˆ–g++æ›¿æ¢æˆem++ï¼‰ï¼Œä½†åœ¨`./configure`çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬ä»ç„¶å¾—åˆ°gccä½œä¸ºæˆ‘ä»¬çš„ç¼–è¯‘å™¨ã€‚

```
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --cflags                            
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --libs                               
install prefix            /usr/local                                                                                                   
source path               .                                                                                                                
C compiler                gcc             # Should be emcc                                                                                             
C library                 glibc                                                                                                           
ARCH                      x86 (generic)                                                                                                     
big-endian                no                                                                                                            
runtime cpu detection     yes                                                                                                         
standalone assembly       no                                                                                                            
x86 assembler             nasm
```

æ¯ä¸ªè‡ªåŠ¨åŒ–å·¥å…·éƒ½æœ‰å…¶å±€é™æ€§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ“ä½œã€‚è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰ä»»ä½•å‚æ•°å¯ä»¥æ‹¯æ•‘æˆ‘ä»¬ã€‚

```
$ ./configure --help
```

åœ¨`Toolchain`é€‰é¡¹ä¸‹ï¼Œæœ‰ä¸€äº›å‚æ•°ç”¨æ¥æŒ‡å®šè¦ä½¿ç”¨çš„ç¼–è¯‘å™¨ã€‚

```
root@57ab95def750:/src# ./configure --help
Usage: configure [options]
Options: [defaults in brackets after descriptions]
Help options:
...
Toolchain options:                                                                                                             
...
  --nm=NM                  use nm tool NM [nm -g]
  --ar=AR                  use archive tool AR [ar]
  --as=AS                  use assembler AS []
  --ln_s=LN_S              use symbolic link tool LN_S [ln -s -f]
  --strip=STRIP            use strip tool STRIP [strip]
  --windres=WINDRES        use windows resource compiler WINDRES [windres]
  --x86asmexe=EXE          use nasm-compatible assembler EXE [nasm]
  --cc=CC                  use C compiler CC [gcc]
  --cxx=CXX                use C compiler CXX [g++]
  --objcc=OCC              use ObjC compiler OCC [gcc]
  --dep-cc=DEPCC           use dependency generator DEPCC [gcc]
  --nvcc=NVCC              use Nvidia CUDA compiler NVCC [nvcc]
  --ld=LD                  use linker LD []
...
```

è®©æˆ‘ä»¬åœ¨`build.sh`ä¸­ä¼ é€’è¿™äº›å‚æ•°æ¥ç”¨emscriptenè¿›è¡Œç¼–è¯‘ã€‚

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
FLAGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
)
emconfigure ./configure "${FLAGS[@]}"
```

> å¯¹äºæœ¬åœ°æ„å»ºï¼Œè¯·ç¡®ä¿`llvm-ranlib`ã€`llvm-as`å’Œ`llvm-nm`å­˜åœ¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œä½ å¯ä»¥åœ¨`$EMSDK_ROOT/upstream/bin`ä¸­æ‰¾åˆ°å®ƒä»¬ã€‚

æœ‰äº†è¿™äº›å‚æ•°ï¼Œ`./configure`å°†éœ€è¦æ›´å¤šçš„æ—¶é—´æ¥è¿è¡Œï¼Œä½†ä½ æœ€ç»ˆä¼šå¾—åˆ°æƒ³è¦çš„è¾“å‡ºã€‚

```
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.39.18/system/bin/sdl2-config --cflags                            
emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.39.18/system/bin/sdl2-config --libs                                     
install prefix            /usr/local                                                                                                   
source path               .                                                                                                         
C compiler                emcc         # emcc as expected                                                                                    
C library                                                                                                                          
ARCH                      x86 (generic)                                                                                                     
big-endian                no                                                                                                              
runtime cpu detection     yes                                                                                                             
standalone assembly       no
```

åœ¨`build.sh`çš„ç»“å°¾å¤„æ·»åŠ `emmake make -j4`ï¼ˆä½ å¯ä»¥å°†å¹¶è¡Œæ€§æé«˜åˆ°åƒ`-j8`é‚£æ ·ï¼Œæˆ–è€…å¹²è„†ä½¿ç”¨`-j`æ¥ä½¿ç”¨æ‰€æœ‰å†…æ ¸ï¼‰ï¼š

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
ARGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
)
emconfigure ./configure "${ARGS[@]}"

# build ffmpeg.wasm
emmake make -j4
```

ç„¶åå®ƒè¿è¡Œå®Œç«‹é©¬æŠ¥é”™ï¼š

```
...
./libavutil/x86/timer.h:39:24: error: invalid output constraint '=a' in asm
                     : "=a" (a), "=d" (d));
                       ^
```

ä»è¾“å‡ºä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šè¿™ä¸ªé”™è¯¯ä¸asmæœ‰å…³ã€‚æ‰“å¼€`./libavutil/x86/timer.h`ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤è¿™ä¸ªé—®é¢˜æ˜¯ç”±x86å†…è”ç¨‹åºå¼•èµ·çš„ï¼Œå®ƒä¸WebAssemblyä¸å…¼å®¹ï¼Œæ‰€ä»¥è§£å†³åŠæ³•æ˜¯åœ¨`build.sh`ä¸­ç¦ç”¨å®ƒã€‚

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
ARGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
  --disable-inline-asm    # disable inline asm
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
)
emconfigure ./configure "${ARGS[@]}"

# build ffmpeg.wasm
emmake make -j4
```

å®ƒå¯ä»¥å·¥ä½œï¼Œå¹¶ä¸”ä¸€ç›´åœ¨ç¼–è¯‘ï¼Œç›´åˆ°æˆ‘ä»¬é‡åˆ°å¦ä¸€ä¸ªé”™è¯¯ã€‚

```
...
CC libavfilter/dnn/dnn_backend_native_layers.o
In file included from libavfilter/aeval.c:26:
In file included from ./libavutil/avassert.h:31:
In file included from ./libavutil/avutil.h:296:
In file included from ./libavutil/common.h:533:
In file included from ./libavutil/internal.h:176:
./libavutil/libm.h:54:32: error: static declaration of 'cbrt' follows non-static declaration
static av_always_inline double cbrt(double x)
                               ^
/emsdk_portable/upstream/emscripten/system/include/libc/math.h:151:13: note: previous declaration is here
double      cbrt(double);
            ^
In file included from libavfilter/aeval.c:26:
```

è¿™ä¸€æ¬¡ï¼Œæ ¹æœ¬åŸå› ä¸æ˜¯é‚£ä¹ˆæ˜æ˜¾ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨`./configure`è¿‡ç¨‹ä¸­æ·±å…¥æŒ–æ˜å‡ºé”™çš„åŸå› ã€‚ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ–‡ä»¶æ˜¯`ffbuild/config.log`ï¼Œå®ƒåŒ…å«äº†`./configure`æœŸé—´çš„æ—¥å¿—ï¼Œå¤§å¤šæ•°æ—¶å€™ä½ å¯ä»¥åœ¨é‚£é‡Œæ‰¾åˆ°æ ¹æœ¬åŸå› ã€‚

é€šè¿‡åœ¨`config.log`ä¸­æœç´¢`cbrt`ï¼Œæˆ‘ä»¬å‘ç°äº†ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š

```
...
check_mathfunc cbrt 1                                                                                                                             test_ld cc                                                                                                                                        test_cc                                                                                                                                           BEGIN /tmp/ffconf.syfN4Irw/test.c                                                                                                                     1 #include <math.h>                                                                                                                               2 float foo(float f, float g) { return cbrt(f); }                                                                                             
    3 int main(void){ return (int) foo; }                                                                                                         
END /tmp/ffconf.syfN4Irw/test.c                                                                                                                   
emcc -D_ISOC99_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_POSIX_C_SOURCE=200112 -D_XOPEN_SOURCE=600 -std=c11 -fomit-frame-pointer -pthread -c -o /tmp/ffconf.syfN4Irw/test.o /tmp/ffconf.syfN4Irw/test.c                                                                                  emcc -Wl,-z,noexecstack -o /tmp/ffconf.syfN4Irw/test /tmp/ffconf.syfN4Irw/test.o                                                                  wasm-ld: error: 'atomics' feature is used by /tmp/ffconf.syfN4Irw/test.o, so --shared-memory must be used
...          
```

è¿™ä¸ªæµ‹è¯•è¯•å›¾æ£€æŸ¥cbrtæ˜¯å¦åœ¨å·¥ä½œï¼Œä½†ç”±äº`atomics`åŠŸèƒ½å‡ºé”™è€Œå¤±è´¥ã€‚`atomics`æ˜¯åœ¨ä½ ä½¿ç”¨`pthread`æ—¶è¢«è¯¢é—®çš„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ·»åŠ `pthread`æ ‡å¿—ã€‚(å…³äº`pthread`æ ‡å¿—çš„æ›´å¤šç»†èŠ‚è¯·çœ‹[è¿™é‡Œ](https://emscripten.org/docs/porting/pthreads.html))

æ›´æ–°build.shï¼š

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
CFLAGS="-s USE_PTHREADS"
LDFLAGS="$CFLAGS"
ARGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
  --disable-inline-asm    # disable inline asm
  --extra-cflags="$CFLAGS"
  --extra-cxxflags="$CFLAGS"
  --extra-ldflags="$LDFLAGS"
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
)
emconfigure ./configure "${ARGS[@]}"

# build ffmpeg.wasm
emmake make -j4
```

å®ƒå¯ä»¥å·¥ä½œï¼Œå¹¶ä¸”ä¸€ç›´åœ¨ç¼–è¯‘ï¼Œç›´åˆ°æˆ‘ä»¬é‡åˆ°å¦ä¸€ä¸ªé”™è¯¯ï¼š

```
...
LD      ffplay_g                                                                                                                                  emcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]                                                                                                           
7 warnings generated.                                                      
wasm-ld: error: initial memory too small, 19491744 bytes needed
...                    
make: *** [Makefile:114: ffplay_g] Error 1
make: *** Waiting for unfinished jobs....
emcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec
:libavutil:libavresample` [-Wlinkflags]
...

```

è¿™æ¬¡çš„é—®é¢˜æ˜¯ç”±äºåˆå§‹å†…å­˜å¤ªå°ï¼ˆEmscriptené»˜è®¤åªæœ‰16MBï¼Œè€Œè¿™é‡Œæœ€å°çš„æ˜¯19+MBï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡`-s INITIAL_MEMORY=33554432`ï¼ˆ32MBï¼‰æ¥æé«˜åˆå§‹å†…å­˜çš„å€¼ã€‚

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
CFLAGS="-s USE_PTHREADS"
LDFLAGS="$CFLAGS -s INITIAL_MEMORY=33554432" # 33554432 bytes = 32 MB
ARGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
  --disable-inline-asm    # disable inline asm
  --extra-cflags="$CFLAGS"
  --extra-cxxflags="$CFLAGS"
  --extra-ldflags="$LDFLAGS"
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
)

emconfigure ./configure "${ARGS[@]}"

# build ffmpeg.wasm
emmake make -j4
```

åœ¨è¿™æ¬¡ä¿®å¤åï¼Œä»ç„¶æœ‰ä¸€ä¸ªé”™è¯¯ï¼š

```
LD      ffplay_g
emcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]
6 warnings generated.
LD      ffmpeg_g
emcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]
9 warnings generated.
LD      ffprobe_g
emcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]
STRIP   ffmpeg
strip:ffmpeg_g: file format not recognized
make: *** [Makefile:107: ffmpeg] Error 1
make: *** Waiting for unfinished jobs....
```

ç”±äºæˆ‘ä»¬æ— æ³•å‰¥ç¦»ï¼ˆå› ä¸ºå®ƒä¸æ˜¯æœ‰æ•ˆçš„äºŒè¿›åˆ¶æ ¼å¼ï¼‰ï¼Œè®©æˆ‘ä»¬ç®€å•åœ°ç”¨`--disable-stripping`ç¦æ­¢å‰¥ç¦»ï¼Œç„¶åé‡æ–°åˆ¶ä½œã€‚

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
CFLAGS="-s USE_PTHREADS"
LDFLAGS="$CFLAGS -s INITIAL_MEMORY=33554432" # 33554432 bytes = 32 MB
ARGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
  --disable-inline-asm    # disable inline asm
  --disable-stripping     # disable stripping
  --extra-cflags="$CFLAGS"
  --extra-cxxflags="$CFLAGS"
  --extra-ldflags="$LDFLAGS"
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
)

emconfigure ./configure "${ARGS[@]}"

# build ffmpeg.wasm
emmake make -j4
```

æœ€åæˆ‘ä»¬æˆåŠŸåœ°å®Œæˆäº†`emmake make -j`éƒ¨åˆ†ï¼Œä½ å¯ä»¥çœ‹åˆ°ffplay / ffplay_gã€ffprobe / ffprobe_gå’Œffmpeg / ffmpeg_gåœ¨æ ¹æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆã€‚å®ƒçœ‹èµ·æ¥å¾ˆå®Œç¾ï¼Œä½†æœ‰ä¸€ä¸ªå¥‡æ€ªçš„`_g`åç¼€ä½¿è¾“å‡ºæ–‡ä»¶åƒè¿™æ ·ã€‚

+ ffmpeg
+ ffmpeg_g
+ ffmpeg_g.wasm
+ ffmpeg_g.worker.js

è¿™é‡Œçš„ffmpegå’Œffmpeg_géƒ½æ˜¯å®é™…çš„jsæ–‡ä»¶ï¼Œç†æƒ³çš„å‘½åæ–¹å¼å¦‚ä¸‹ï¼š

+ ffmpeg / ffmpeg_g => ffmpeg.js
+ ffmpeg_g.wasm => ffmpeg.wasm
+ ffmpeg_g.worker.js => ffmpeg.worker.js

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±æ¥æ„å»ºå®ƒã€‚å»ºç«‹ffmpegçš„å‘½ä»¤å¯ä»¥é€šè¿‡è¿è¡Œ`emmake make -n`æ¥æå–ã€‚

```
...
printf "LD\t%s\n" ffmpeg_g; emcc -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample -Wl,--as-needed -Wl,-z,noexecstack -Wl,--warn-common -Wl,-rpath-link=libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample -Qunused-arguments   -o ffmpeg_g fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil  -lm -pthread -lm -lm -pthread -lm -lm -lm -pthread -lm
printf "CP\t%s\n" ffmpeg; cp -p ffmpeg_g ffmpeg
...
```

å†åŠ ä¸Šä¸‹é¢çš„å‘½ä»¤ï¼š

```shell
emcc \
  -I. -I./fftools \
  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample \
  -Qunused-arguments \
  -o ffmpeg_g fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o \
  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm
```

ç”±äºæˆ‘ä»¬æ­£åœ¨æ„å»ºè‡ªå·±çš„ç‰ˆæœ¬ï¼Œè®©æˆ‘ä»¬åœ¨`./configure`æ­¥éª¤ä¸­æ·»åŠ `--disable-programs`å’Œ`--disable-doc`ï¼Œä»¥åŠ å¿«æ„å»ºé€Ÿåº¦ï¼ŒåŒæ—¶åœ¨æ„å»ºffmpegæ—¶æ·»åŠ ä¸€äº›å¿…è¦çš„æ ‡å¿—ã€‚

```shell
#!/bin/bash -x

# verify Emscripten version
emcc -v

# configure FFMpeg with Emscripten
CFLAGS="-s USE_PTHREADS"
LDFLAGS="$CFLAGS -s INITIAL_MEMORY=33554432" # 33554432 bytes = 32 MB
CONFIG_ARGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile  # enable cross compile
  --disable-x86asm        # disable x86 asm
  --disable-inline-asm    # disable inline asm
  --disable-stripping     # disable stripping
  --disable-programs      # disable programs build (incl. ffplay, ffprobe & ffmpeg)
  --disable-doc           # disable doc
  --extra-cflags="$CFLAGS"
  --extra-cxxflags="$CFLAGS"
  --extra-ldflags="$LDFLAGS"
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
)
emconfigure ./configure "${CONFIG_ARGS[@]}"

# build dependencies
emmake make -j4

# build ffmpeg.wasm
mkdir -p wasm/dist
ARGS=(
  -I. -I./fftools
  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample
  -Qunused-arguments
  -o wasm/dist/ffmpeg.js fftools/ffmpeg_opt.c fftools/ffmpeg_filter.c fftools/ffmpeg_hw.c fftools/cmdutils.c fftools/ffmpeg.c
  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm
  -s USE_SDL=2                    # use SDL2
  -s USE_PTHREADS=1               # enable pthreads support
  -s INITIAL_MEMORY=33554432      # 33554432 bytes = 32 MB
)
emcc "${ARGS[@]}"
```

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª[basic.html](https://github.com/ffmpegwasm/ffmpeg.wasm-core/blob/n4.3.1-p2/wasm/basic.html)æ¥æµ‹è¯•ffmpeg.wasmæ˜¯å¦åœ¨å·¥ä½œã€‚

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <script src="./dist/ffmpeg.js"></script>
</head>
<body>
</body>
</html>
```

è¿è¡Œä¸€ä¸ªè½»é‡çº§çš„ç½‘ç»œæœåŠ¡å™¨ï¼ˆä¾‹å¦‚`python3 -m http.server 3000`ï¼‰å¹¶è®¿é—®ç½‘é¡µï¼ˆä¾‹å¦‚http://localhost:3000/basic.htmlï¼‰ï¼Œç„¶åæ‰“å¼€Chrome DevToolsã€‚

![img](https://miro.medium.com/max/1400/1*N1KJtAcdlhYBzJ2XSv3XGA.png)

ä½ å¯ä»¥çœ‹åˆ°å®ƒçš„è¾“å‡ºä¸åŸæ¥çš„FFmpegç›¸ä¼¼ï¼Œå®ƒç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹æ¥æ‰“ç£¨æˆ‘ä»¬çš„ffmpeg.wasmåº“ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œè®¿é—®èµ„æºåº“ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼šhttps://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p2

ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œä¸‹è½½æ„å»ºçš„å·¥ä»¶ï¼šhttps://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p2

å…³äºå¦‚ä½•æ‰“ç£¨å’Œåˆ›å»ºä¸€ä¸ª "çœŸæ­£çš„ "ffmpeg.wasmåº“ï¼Œè¯·å…³æ³¨**ç¼–è¯‘WebAssemblyç‰ˆæœ¬çš„FFmpegï¼ˆ ffmpeg.wasmï¼‰ï¼šï¼ˆ3ï¼‰ ffmpeg.wasm v0.1 - å°†aviè½¬ä¸ºmp4**çš„æ–°ä¸€ç¯‡æ–‡ç« ã€‚ğŸ˜ƒ



æ³¨ï¼š**ç‰¹åˆ«æ„Ÿè°¢æŠ€æœ¯æŒ‡å¯¼dazhao(èµµè¾¾)å¯¹æœ¬æ–‡ç¿»è¯‘çš„å®¡é˜…æŒ‡æ­£**ã€‚

æˆ‘çš„åšå®¢å³å°†åŒæ­¥è‡³è…¾è®¯äº‘+ç¤¾åŒºï¼Œé‚€è¯·å¤§å®¶ä¸€åŒå…¥é©»ï¼šhttps://cloud.tencent.com/developer/support-plan?invite_code=38vev0ndgtogc